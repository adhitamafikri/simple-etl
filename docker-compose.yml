services:
  postgres:
    image: postgres:17-alpine
    container_name: kjoacademy-etl-postgres
    restart: unless-stopped
    env_file:
      - .env
    environment:
      POSTGRES_USER: ${PG_USER}
      POSTGRES_PASSWORD: ${PG_PASSWORD}
      POSTGRES_DB: ${PG_DATABASE}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - '${PG_PORT:-5432}:5432'
    volumes:
      - pg-data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    networks:
      - kjoacademy-etl-net
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${PG_USER} -d ${PG_DATABASE}']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    command:
      - postgres
      - -c
      - max_connections=${PG_MAX_CONNECTIONS:-100}
      - -c
      - shared_buffers=${PG_SHARED_BUFFERS:-128MB}
      - -c
      - effective_cache_size=${PG_EFFECTIVE_CACHE_SIZE:-4GB}
      - -c
      - maintenance_work_mem=${PG_MAINTENANCE_WORK_MEM:-64MB}
      - -c
      - checkpoint_completion_target=${PG_CHECKPOINT_COMPLETION_TARGET:-0.9}
      - -c
      - wal_buffers=${PG_WAL_BUFFERS:-16MB}
      - -c
      - default_statistics_target=${PG_DEFAULT_STATISTICS_TARGET:-100}
      - -c
      - random_page_cost=${PG_RANDOM_PAGE_COST:-1.1}
      - -c
      - effective_io_concurrency=${PG_EFFECTIVE_IO_CONCURRENCY:-200}
      - -c
      - work_mem=${PG_WORK_MEM:-4MB}
      - -c
      - min_wal_size=${PG_MIN_WAL_SIZE:-1GB}
      - -c
      - max_wal_size=${PG_MAX_WAL_SIZE:-4GB}

volumes:
  pg-data:
    driver: local

networks:
  kjoacademy-etl-net:
    driver: bridge
